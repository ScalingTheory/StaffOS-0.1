# StaffOS Production Deployment Guide

## 1. Repository Structure Summary

```
StaffOS/
├── client/                    # Frontend (React + Vite)
│   ├── src/                   # React source code
│   ├── config.ts              # API URL configuration
│   └── index.html             # Entry HTML
├── server/                    # Backend (Express + Node.js)
│   ├── index.ts               # Development entry point
│   ├── db.ts                  # Database connection (Neon)
│   ├── routes.ts              # API routes
│   └── ...                    # Other server modules
├── shared/                    # Shared types and schemas
│   └── schema.ts              # Drizzle ORM schema (PostgreSQL)
├── vercel.json                # Vercel deployment config
├── render.yaml                # Render deployment config
└── package.json               # Project scripts
```

**Frontend Path:** `client/`
**Backend Path:** `server/`
**Shared Types:** `shared/`

---

## 2. Environment Variables

### Local Development (.env.local)

```bash
# Database
DATABASE_URL=postgresql://username:password@localhost:5432/staffos_dev

# Server
NODE_ENV=development
PORT=5000
SESSION_SECRET=local-dev-secret-change-me

# Optional: Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Optional: Email (Resend)
RESEND_API_KEY=your-resend-api-key
```

### Dev Environment (Render DEV Service)

```bash
# Database - MUST point to Neon DEV database
DATABASE_URL=postgresql://user:pass@ep-xxx-dev.us-east-2.aws.neon.tech/staffos_dev?sslmode=require

# Server
NODE_ENV=production
SESSION_SECRET=<auto-generated>
FRONTEND_URL=https://staffos-dev.vercel.app

# Optional OAuth
GOOGLE_CLIENT_ID=your-dev-google-client-id
GOOGLE_CLIENT_SECRET=your-dev-google-client-secret

# Optional Email
RESEND_API_KEY=your-dev-resend-api-key
```

### Production Environment (Render PROD Service)

```bash
# Database - MUST point to Neon PROD database
DATABASE_URL=postgresql://user:pass@ep-xxx-prod.us-east-2.aws.neon.tech/staffos_prod?sslmode=require

# Server
NODE_ENV=production
SESSION_SECRET=<auto-generated>
FRONTEND_URL=https://staffos.vercel.app

# Optional OAuth
GOOGLE_CLIENT_ID=your-prod-google-client-id
GOOGLE_CLIENT_SECRET=your-prod-google-client-secret

# Optional Email
RESEND_API_KEY=your-prod-resend-api-key
```

### Vercel Frontend (Preview/Dev)

```bash
VITE_API_URL=https://staffos-backend-dev.onrender.com
```

### Vercel Frontend (Production)

```bash
VITE_API_URL=https://staffos-backend.onrender.com
```

---

## 3. Backend Deployment (Render)

### 3.1 Create TWO Separate Render Services

#### DEV Backend Service

1. Go to Render Dashboard > New > Web Service
2. Connect your GitHub repo: `ScalingTheory/StaffOS-0.1`
3. Configure:
   - **Name:** `staffos-backend-dev`
   - **Branch:** `dev`
   - **Environment:** Node
   - **Build Command:** `npm install && npm run build:backend`
   - **Start Command:** `npm run start:backend`
   - **Health Check Path:** `/api/health`

4. Add Environment Variables:
   ```
   NODE_ENV=production
   NODE_VERSION=20.10.0
   DATABASE_URL=<Neon DEV database URL>
   SESSION_SECRET=<generate unique value>
   FRONTEND_URL=https://staffos-dev.vercel.app
   ```

#### PROD Backend Service

1. Go to Render Dashboard > New > Web Service
2. Connect your GitHub repo: `ScalingTheory/StaffOS-0.1`
3. Configure:
   - **Name:** `staffos-backend`
   - **Branch:** `main`
   - **Environment:** Node
   - **Build Command:** `npm install && npm run build:backend`
   - **Start Command:** `npm run start:backend`
   - **Health Check Path:** `/api/health`

4. Add Environment Variables:
   ```
   NODE_ENV=production
   NODE_VERSION=20.10.0
   DATABASE_URL=<Neon PROD database URL>
   SESSION_SECRET=<generate unique value>
   FRONTEND_URL=https://staffos.vercel.app
   ```

### 3.2 Backend Build & Start Commands

```bash
# Build (compiles TypeScript to JavaScript)
npm run build:backend
# Runs: esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

# Start (runs compiled code)
npm run start:backend
# Runs: cross-env NODE_ENV=production node dist/index.js
```

---

## 4. Frontend Deployment (Vercel)

### 4.1 Production Deployment (main branch)

1. Go to Vercel Dashboard > Add New > Project
2. Import from GitHub: `ScalingTheory/StaffOS-0.1`
3. Configure:
   - **Framework Preset:** Vite
   - **Root Directory:** (leave empty, uses project root)
   - **Build Command:** `npm run build:frontend`
   - **Output Directory:** `dist/public`
   - **Install Command:** `npm install`

4. Production Branch Settings:
   - **Production Branch:** `main`
   - **Auto Deploy:** Enabled for `main` only

5. Environment Variables (Production):
   ```
   VITE_API_URL=https://staffos-backend.onrender.com
   ```

### 4.2 Preview/Dev Deployment

1. In the same Vercel project, go to Settings > Environment Variables
2. Add variable with **Preview** environment scope:
   ```
   VITE_API_URL=https://staffos-backend-dev.onrender.com
   ```

3. Configure Preview Branches:
   - Settings > Git > Production Branch: `main`
   - All other branches (including `dev`) will be Preview deployments

### 4.3 Frontend Build Command

```bash
npm run build:frontend
# Runs: vite build
# Output: dist/public/
```

---

## 5. Git Workflow Rules

### 5.1 Daily Developer Workflow

```bash
# 1. Always start from dev branch
git checkout dev
git pull origin dev

# 2. Create feature branch from dev
git checkout -b feature/your-feature-name

# 3. Make changes and commit
git add .
git commit -m "feat: description of changes"

# 4. Push feature branch
git push origin feature/your-feature-name

# 5. Create Pull Request: feature/your-feature-name -> dev
# 6. After review, merge PR into dev
# 7. Delete feature branch after merge
```

### 5.2 Release Workflow (dev to main)

```bash
# 1. Ensure dev is fully tested and stable
git checkout dev
git pull origin dev

# 2. Create release branch
git checkout -b release/v1.x.x

# 3. Run final tests
npm run check
npm run build

# 4. Push release branch
git push origin release/v1.x.x

# 5. Create Pull Request: release/v1.x.x -> main
# 6. Require at least 2 approvals
# 7. Merge PR (use "Squash and merge" for clean history)
# 8. Tag the release
git checkout main
git pull origin main
git tag -a v1.x.x -m "Release v1.x.x"
git push origin v1.x.x

# 9. Delete release branch
git branch -d release/v1.x.x
git push origin --delete release/v1.x.x
```

### 5.3 Hotfix Workflow (Critical Production Fixes)

```bash
# 1. Create hotfix from main
git checkout main
git pull origin main
git checkout -b hotfix/critical-fix

# 2. Apply fix and test
git add .
git commit -m "fix: critical production issue"

# 3. Create PR: hotfix/critical-fix -> main
# 4. After merge, backport to dev
git checkout dev
git pull origin dev
git cherry-pick <hotfix-commit-hash>
git push origin dev
```

---

## 6. Validation Checklist

### Pre-Deployment Checks

- [ ] All tests pass locally (`npm run check`)
- [ ] Build succeeds (`npm run build`)
- [ ] No hardcoded secrets or API keys in code
- [ ] Environment variables documented for each environment
- [ ] Database migrations reviewed (if any)

### Dev Environment Validation

- [ ] Render DEV service deployed successfully
- [ ] Backend health check passes: `curl https://staffos-backend-dev.onrender.com/api/health`
- [ ] Vercel Preview deployment works
- [ ] Frontend connects to DEV backend (check browser console)
- [ ] Database connects to Neon DEV (check Render logs)
- [ ] User authentication works on dev
- [ ] Core features tested on dev

### Production Deployment Validation

- [ ] PR from `release/*` to `main` approved by 2+ reviewers
- [ ] Render PROD service auto-deploys from `main`
- [ ] Backend health check passes: `curl https://staffos-backend.onrender.com/api/health`
- [ ] Vercel Production deployment succeeds
- [ ] Frontend connects to PROD backend
- [ ] Database connects to Neon PROD (verify in logs)
- [ ] Authentication works on production
- [ ] Core user flows tested on production
- [ ] No console errors in browser
- [ ] Performance acceptable (page load < 3s)

### Post-Deployment Monitoring

- [ ] Monitor Render logs for errors
- [ ] Monitor Vercel deployment status
- [ ] Check Neon database metrics
- [ ] Verify no unexpected database queries
- [ ] Confirm session handling works correctly

---

## 7. Database Setup (Neon PostgreSQL)

### Create Separate Databases

1. **Neon DEV Database:**
   - Project Name: `staffos-dev`
   - Branch: `main` (or `dev`)
   - Get connection string for DEV Render service

2. **Neon PROD Database:**
   - Project Name: `staffos-prod`
   - Branch: `main`
   - Get connection string for PROD Render service

### Database Migration

After setting up databases, push schema:

```bash
# For DEV database
DATABASE_URL="your-neon-dev-url" npm run db:push

# For PROD database
DATABASE_URL="your-neon-prod-url" npm run db:push
```

---

## 8. Critical Safety Rules

1. **NEVER** force push to `main` branch
2. **NEVER** deploy directly to production from `dev`
3. **NEVER** share database URLs between dev and prod
4. **NEVER** commit `.env` files or secrets to repository
5. **ALWAYS** use Pull Requests for all changes to `main`
6. **ALWAYS** require reviews for production deployments
7. **ALWAYS** test on dev before releasing to main
8. **ALWAYS** use separate Neon projects for dev and prod databases

---

## 9. Quick Reference Commands

```bash
# Local Development
npm run dev                    # Start development server (port 5000)

# Build
npm run build                  # Build both frontend and backend
npm run build:frontend         # Build frontend only (Vite)
npm run build:backend          # Build backend only (esbuild)

# Production Start
npm run start                  # Start production server
npm run start:backend          # Start backend only

# Database
npm run db:push                # Push schema changes to database

# Type Checking
npm run check                  # Run TypeScript type check
```

---

## 10. Troubleshooting

### Backend Not Starting on Render

1. Check `NODE_VERSION` is set to `20.10.0`
2. Verify `DATABASE_URL` is correct and accessible
3. Check Render logs for specific errors
4. Ensure health check path `/api/health` exists

### Frontend Not Connecting to Backend

1. Verify `VITE_API_URL` is set correctly in Vercel
2. Check CORS settings in backend (should allow Vercel domains)
3. Verify backend is running and accessible
4. Check browser console for network errors

### Database Connection Issues

1. Verify `DATABASE_URL` includes `?sslmode=require`
2. Check Neon project is active (not suspended)
3. Verify IP allowlist if enabled on Neon
4. Check connection pool settings in `server/db.ts`
